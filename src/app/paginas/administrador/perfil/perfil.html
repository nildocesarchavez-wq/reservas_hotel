<div class="app-container">
  <!-- HEADER TOP -->
  <app-header-admin></app-header-admin>

  <!-- SIDEBAR -->
  <app-sidebar-admin></app-sidebar-admin>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <div class="content-wrapper">
      <!-- PAGE HEADER -->
      <div class="page-header">
        <h1 class="page-title">ADMINISTRADORES</h1>
        <p class="page-subtitle">Gestión de cuentas de administradores</p>
        <div class="user-info" *ngIf="usuarioActual">
          <span class="badge" [class.badge-admin-principal]="esAdminPrincipal" [class.badge-admin]="!esAdminPrincipal">
            <i class="fa" [class.fa-crown]="esAdminPrincipal" [class.fa-user-shield]="!esAdminPrincipal"></i>
            {{ esAdminPrincipal ? 'Administrador Principal' : 'Administrador' }}
          </span>
        </div>
      </div>

      <!-- LOADING INDICATOR -->
      <div *ngIf="isLoading" class="loading-container">
        <div class="spinner"></div>
        <p>Cargando información...</p>
      </div>

      <!-- MENSAJES -->
      <div *ngIf="mensajeExito" class="alert alert-success">
        <i class="fa fa-check-circle"></i>
        {{ mensajeExito }}
      </div>

      <div *ngIf="mensajeError" class="alert alert-error">
        <i class="fa fa-exclamation-circle"></i>
        {{ mensajeError }}
      </div>

      <!-- CONTENIDO -->
      <div *ngIf="!isLoading">
        <!-- TABLA DE USUARIOS -->
        <div class="content-grid" style="grid-template-columns: 1fr;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">LISTA DE USUARIOS ADMINISTRADORES</h3>
              <span class="badge badge-primary">{{ administradores.length }}</span>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table class="data-table" id="dataTables-example">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nombre Usuario</th>
                      <th>Email</th>
                      <th>Tipo</th>
                      <th>Fecha Creación</th>
                      <th>Última Actualización</th>
                      <th>Actualizar</th>
                      <th>Eliminar</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let admin of administradores; let i = index" 
                        [class.gradeC]="i % 2 === 0"
                        [class.gradeU]="i % 2 !== 0"
                        [class.current-user]="usuarioActual?.id === admin.id">
                      <td>{{ admin.id.substring(0, 8) }}...</td>
                      <td>
                        <strong>{{ admin.displayName }}</strong>
                        <span class="badge badge-you" *ngIf="usuarioActual?.id === admin.id">Tú</span>
                      </td>
                      <td>{{ admin.email }}</td>
                      <td>
                        <span class="badge" [class.badge-admin-principal]="admin.esAdminPrincipal" [class.badge-admin]="!admin.esAdminPrincipal">
                          <i class="fa" [class.fa-crown]="admin.esAdminPrincipal" [class.fa-user-shield]="!admin.esAdminPrincipal"></i>
                          {{ admin.esAdminPrincipal ? 'Principal' : 'Admin' }}
                        </span>
                      </td>
                      <td>{{ formatearFecha(admin.createdAt) }}</td>
                      <td>{{ formatearFecha(admin.updatedAt) }}</td>
                      <td>
                        <button 
                          class='btn btn-primary btn-sm'
                          [disabled]="!puedeEditarUsuario(admin)"
                          [class.btn-disabled]="!puedeEditarUsuario(admin)"
                          (click)="abrirModalEditar(admin)"
                          [title]="puedeEditarUsuario(admin) ? 'Editar perfil' : 'Solo puedes editar tu propio perfil'">
                          <i class='fa fa-edit'></i> Actualizar
                        </button>
                      </td>
                      <td>
                        <button 
                          class='btn btn-danger btn-sm'
                          [disabled]="!puedeEliminarUsuario(admin)"
                          [class.btn-disabled]="!puedeEliminarUsuario(admin)"
                          (click)="eliminarUsuario(admin)"
                          [title]="puedeEliminarUsuario(admin) ? 'Eliminar usuario' : 'Solo el admin principal puede eliminar'">
                          <i class='fa fa-trash'></i> Eliminar
                        </button>
                      </td>
                    </tr>

                    <tr *ngIf="administradores.length === 0">
                      <td colspan="8" class="no-data">
                        <i class="fa fa-users"></i>
                        <p>No hay administradores registrados</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- BOTÓN AGREGAR NUEVO ADMINISTRADOR -->
          <div class="panel-body">
            <button 
              class="btn btn-primary" 
              (click)="abrirModalAgregar()"
              [disabled]="!puedeAgregarAdmin()">
              <i class="fa fa-plus"></i> Agregar nuevo administrador
            </button>
          </div>

          <!-- INFO SOBRE PERMISOS -->
          <div class="info-permisos">
            <div class="info-card">
              <i class="fa fa-info-circle"></i>
              <div>
                <h4>Información de Permisos</h4>
                <ul>
                  <li><i class="fa fa-crown"></i> <strong>Administrador Principal:</strong> Puede eliminar otros administradores</li>
                  <li><i class="fa fa-user-shield"></i> <strong>Administrador:</strong> Puede agregar nuevos administradores y editar su propio perfil</li>
                  <li><i class="fa fa-lock"></i> Cada administrador solo puede editar su propia información</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- MODAL PARA EDITAR USUARIO -->
  <div class="modal" [class.show]="showEditModal" (click)="cerrarModalEditar()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Actualizar Mi Perfil</h4>
          <button type="button" class="close" (click)="cerrarModalEditar()">&times;</button>
        </div>
        <form (ngSubmit)="actualizarUsuario()">
          <div class="modal-body">
            <div class="form-group">
              <label for="editUsername">Nombre de Usuario</label>
              <input 
                type="text" 
                id="editUsername" 
                class="form-control"
                [(ngModel)]="editForm.displayName"
                name="displayName"
                placeholder="Ingrese el nombre de usuario" 
                required>
            </div>

            <div class="form-group">
              <label for="editEmail">Correo Electrónico</label>
              <input 
                type="email" 
                id="editEmail" 
                class="form-control"
                [(ngModel)]="editForm.email"
                name="email"
                placeholder="Ingrese el correo electrónico" 
                required>
            </div>

            <div class="form-group">
              <label for="editPassword">
                Nueva Contraseña 
                <small class="text-muted">(opcional - dejar vacío para no cambiar)</small>
              </label>
              <input 
                type="password" 
                id="editPassword" 
                class="form-control"
                [(ngModel)]="editForm.newPassword"
                name="newPassword"
                placeholder="Ingrese nueva contraseña">
              <small class="form-text">Mínimo 6 caracteres</small>
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cerrarModalEditar()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading">
              <i class="fa fa-save"></i>
              {{ isLoading ? 'Actualizando...' : 'Actualizar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL PARA AGREGAR NUEVO USUARIO -->
  <div class="modal" [class.show]="showAddModal" (click)="cerrarModalAgregar()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Agregar Nuevo Administrador</h4>
          <button type="button" class="close" (click)="cerrarModalAgregar()">&times;</button>
        </div>
        <form (ngSubmit)="agregarNuevoAdmin()">
          <div class="modal-body">
            <div class="form-group">
              <label for="newUsername">Nombre de Usuario *</label>
              <input 
                type="text" 
                id="newUsername" 
                class="form-control"
                [(ngModel)]="addForm.displayName"
                name="displayName"
                placeholder="Ingrese el nombre completo" 
                required>
            </div>

            <div class="form-group">
              <label for="newEmail">Correo Electrónico *</label>
              <input 
                type="email" 
                id="newEmail" 
                class="form-control"
                [(ngModel)]="addForm.email"
                name="email"
                placeholder="ejemplo@hotel.com" 
                required>
            </div>

            <div class="form-group">
              <label for="newPassword">Contraseña *</label>
              <input 
                type="password" 
                id="newPassword" 
                class="form-control"
                [(ngModel)]="addForm.password"
                name="password"
                placeholder="Mínimo 6 caracteres" 
                required>
              <small class="form-text">La contraseña debe tener al menos 6 caracteres</small>
            </div>

            <div class="info-box">
              <i class="fa fa-info-circle"></i>
              <p>Se creará una cuenta de administrador (no principal) con acceso al sistema.</p>
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cerrarModalAgregar()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading">
              <i class="fa fa-plus"></i>
              {{ isLoading ? 'Agregando...' : 'Agregar Administrador' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>